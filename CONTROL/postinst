#!/bin/bash
set -e

CHROOT_DIR=/data/ubuntu
VENV_DIR=/root/venv
PLUGIN_DIR=/usr/lib/enigma2/python/Plugins/SystemPlugins/UbuntuCockpit

# Copy bash scripts
cp $PLUGIN_DIR/chroot/*_chroot $CHROOT_DIR/root/.
chmod +x /data/ubuntu/root/*_chroot

# Disable systemd
echo -e "#!/bin/sh\nexit 0" > $CHROOT/var/lib/dpkg/info/systemd.postinst
chmod +x $CHROOT/var/lib/dpkg/info/systemd.postinst

$CHROOT_DIR/root/mount_chroot

echo "[*] Entering chroot and setting up Python..."
chroot "$CHROOT_DIR" /bin/bash -c "
  set -e
  echo '[*] Updating package lists...'
  DEBIAN_FRONTEND=noninteractive apt update

  echo '[*] Installing Python, venv, pip, and build dependencies...'
  DEBIAN_FRONTEND=noninteractive apt install -y \
    python3 \
    python3-venv \
    python3-pip \
    # python3-dev \
    build-essential \
    libssl-dev \
    libffi-dev

  echo '[*] Creating virtualenv at $VENV_DIR ...'
  python3 -m venv $VENV_DIR
  echo "[âœ“] Python venv installed: $CHROOT_DIR$VENV_DIR"
"

echo "[*] Unmounting chroot filesystems..."
$CHROOT_DIR/root/umount_chroot

# Create plugins directory if it doesn't exist
mkdir -p $CHROOT_DIR/root/plugins
# Create Enigma2 configuration directory if it doesn't exist
mkdir -p $CHROOT_DIR/etc/enigma2

dpkg-trigger --no-await ubuntu-update-trigger

echo "***********************************"
echo "*          UbuntuCockpit          *"
echo "*               by                *"
echo "*          dream-alpha            *"
echo "***********************************"
echo ""
echo "Plugin UbuntuCockpit installed successfully."
echo ""
exit 0
